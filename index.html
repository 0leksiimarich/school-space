<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Space</title>
    <!-- CSS & Fonts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signInWithPopup, GoogleAuthProvider, signOut, updateProfile, setPersistence, browserLocalPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        // Глобальний об'єкт для доступу з React
        window.FirebaseSDK = { 
            initializeApp, getAuth, signInAnonymously, onAuthStateChanged, 
            signInWithEmailAndPassword, createUserWithEmailAndPassword, 
            signInWithPopup, GoogleAuthProvider, signOut, updateProfile, 
            setPersistence, browserLocalPersistence, browserSessionPersistence,
            getFirestore, collection, addDoc, onSnapshot, serverTimestamp, doc, setDoc, getDoc 
        };
    </script>

    <style>
        body { background-color: #e0e5ec; font-family: 'Inter', sans-serif; overflow-x: hidden; }
        .neomorph-shadow { box-shadow: 12px 12px 24px #bec3c9, -12px -12px 24px #ffffff; }
        .neomorph-inset { box-shadow: inset 5px 5px 10px #bec3c9, inset -5px -5px 10px #ffffff; }
        .neomorph-button-shadow { box-shadow: 6px 6px 12px #bec3c9, -6px -6px 12px #ffffff; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { 
            initializeApp, getAuth, signInAnonymously, onAuthStateChanged, 
            signInWithPopup, GoogleAuthProvider, signOut, setPersistence, 
            browserLocalPersistence, browserSessionPersistence,
            getFirestore, collection, addDoc, onSnapshot, serverTimestamp, doc, setDoc, getDoc 
        } = window.FirebaseSDK;

        // Конфігурація Firebase (буде замінена середовищем або введіть вручну)
        const firebaseConfig = JSON.parse(window.__firebase_config || '{}');
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = window.__app_id || 'school-space-v2';

        // Компонент іконок Lucide
        const Icon = ({ name, size = 20, className = "" }) => {
            const [iconContent, setIconContent] = useState("");
            useEffect(() => {
                if (window.lucide) {
                    const icon = window.lucide.icons[name];
                    if (icon) setIconContent(icon.toSvg({ width: size, height: size, class: className }));
                }
            }, [name, size, className]);
            return <span className="inline-flex" dangerouslySetInnerHTML={{ __html: iconContent }} />;
        };

        const styles = {
            neptunButton: "bg-[#e0e5ec] neomorph-button-shadow active:shadow-[inset_4px_4px_8px_#bec3c9,inset_-4px_-4px_8px_#ffffff] disabled:opacity-50 transition-all duration-200",
            neptunCard: "bg-[#e0e5ec] neomorph-shadow rounded-3xl",
            neptunInput: "bg-[#e0e5ec] neomorph-inset focus:outline-none rounded-2xl p-4 w-full text-sm text-gray-700 placeholder:text-gray-400",
        };

        function App() {
            const [user, setUser] = useState(null);
            const [userData, setUserData] = useState(null);
            const [activeTab, setActiveTab] = useState('feed');
            const [posts, setPosts] = useState([]);
            const [messages, setMessages] = useState([]);
            const [loading, setLoading] = useState(true);
            const [showInstallGuide, setShowInstallGuide] = useState(false);

            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, async (u) => {
                    if (u) {
                        setUser(u);
                        const userDoc = await getDoc(doc(db, 'artifacts', appId, 'users', u.uid, 'profile', 'info'));
                        if (userDoc.exists()) setUserData(userDoc.data());
                    } else {
                        setUser(null);
                        setUserData(null);
                    }
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user) return;
                const unsubPosts = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'posts'), (s) => {
                    setPosts(s.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)));
                }, (err) => console.error(err));
                
                const unsubChat = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'messages'), (s) => {
                    setMessages(s.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0)));
                }, (err) => console.error(err));
                
                return () => { unsubPosts(); unsubChat(); };
            }, [user]);

            if (loading) return <div className="flex h-screen items-center justify-center font-black italic text-gray-400 uppercase tracking-widest animate-pulse">School Space...</div>;
            if (showInstallGuide) return <InstallGuide onClose={() => setShowInstallGuide(false)} />;
            if (!user) return <AuthScreen onShowGuide={() => setShowInstallGuide(true)} />;

            return (
                <div className="min-h-screen flex flex-col md:flex-row h-screen overflow-hidden">
                    {/* Sidebar Desktop */}
                    <aside className="hidden md:flex flex-col w-64 p-6 border-r border-gray-200 shrink-0">
                        <h1 className="text-2xl font-black italic mb-10 text-gray-800">school space</h1>
                        <nav className="flex-1 space-y-4">
                            <SidebarBtn active={activeTab === 'feed'} onClick={() => setActiveTab('feed')} icon="Home" label="Стрічка" />
                            <SidebarBtn active={activeTab === 'chat'} onClick={() => setActiveTab('chat')} icon="MessageSquare" label="Чат" />
                            <SidebarBtn active={activeTab === 'post'} onClick={() => setActiveTab('post')} icon="PlusSquare" label="Створити" />
                            <SidebarBtn active={activeTab === 'profile'} onClick={() => setActiveTab('profile')} icon="User" label="Профіль" />
                        </nav>
                        <button onClick={() => signOut(auth)} className="mt-4 p-4 text-red-500 font-bold flex items-center gap-2 transition-transform active:scale-95"><Icon name="LogOut" /> Вийти</button>
                    </aside>

                    <div className="flex-1 flex flex-col h-full relative">
                        {/* Mobile Header */}
                        <header className="md:hidden p-5 flex justify-between items-center bg-[#e0e5ec] shrink-0 border-b border-white/50">
                            <h1 className="text-xl font-black italic text-gray-800 uppercase tracking-tighter">school space</h1>
                            <button onClick={() => setShowInstallGuide(true)} className={`${styles.neptunButton} p-3 rounded-full text-blue-600`}><Icon name="Download" size={18} /></button>
                        </header>

                        {/* Main Content */}
                        <main className="flex-1 overflow-y-auto p-4 md:p-12 pb-24">
                            <div className="max-w-2xl mx-auto">
                                {activeTab === 'feed' && <Feed posts={posts} />}
                                {activeTab === 'chat' && (user.isAnonymous ? <Locked message="Чат лише для зареєстрованих учнів" /> : <Chat messages={messages} user={user} userData={userData} />)}
                                {activeTab === 'post' && (user.isAnonymous ? <Locked message="Публікації лише для учнів" /> : <CreatePost onDone={() => setActiveTab('feed')} user={user} userData={userData} />)}
                                {activeTab === 'profile' && <ProfileComponent user={user} userData={userData} onShowGuide={() => setShowInstallGuide(true)} />}
                            </div>
                        </main>

                        {/* Mobile Bottom Nav */}
                        <nav className="md:hidden fixed bottom-4 left-1/2 -translate-x-1/2 w-[92%] h-16 bg-[#e0e5ec]/90 backdrop-blur-lg neomorph-shadow flex items-center justify-around rounded-3xl z-20 border border-white/30">
                            <NavButton active={activeTab === 'feed'} onClick={() => setActiveTab('feed')} icon="Home" />
                            <NavButton active={activeTab === 'chat'} onClick={() => setActiveTab('chat')} icon="MessageSquare" />
                            <button onClick={() => setActiveTab('post')} className="w-12 h-12 rounded-full bg-blue-600 text-white flex items-center justify-center shadow-lg active:scale-90 transition-all -top-4 relative border-4 border-[#e0e5ec]"><Icon name="PlusSquare" size={24} /></button>
                            <NavButton active={activeTab === 'profile'} onClick={() => setActiveTab('profile')} icon="User" />
                        </nav>
                    </div>
                </div>
            );
        }

        function SidebarBtn({ active, onClick, icon, label }) {
            return (
                <button onClick={onClick} className={`w-full flex items-center gap-4 p-4 rounded-2xl transition-all font-bold text-sm ${active ? 'text-blue-600 neomorph-inset bg-white/10' : 'text-gray-500 hover:bg-white/10'}`}>
                    <Icon name={icon} /> {label}
                </button>
            );
        }

        function NavButton({ active, onClick, icon }) {
            return <button onClick={onClick} className={`p-4 rounded-2xl transition-all ${active ? 'text-blue-600' : 'text-gray-400'}`}><Icon name={icon} size={22} /></button>;
        }

        function AuthScreen({ onShowGuide }) {
            const [rememberMe, setRememberMe] = useState(true);
            const [isLoggingIn, setIsLoggingIn] = useState(false);

            const handleGoogle = async () => {
                setIsLoggingIn(true);
                try {
                    await setPersistence(auth, rememberMe ? browserLocalPersistence : browserSessionPersistence);
                    const provider = new GoogleAuthProvider();
                    await signInWithPopup(auth, provider);
                } catch (e) { 
                    console.error(e);
                    alert("Помилка авторизації. Переконайтеся, що домен додано в дозволені в Firebase."); 
                } finally {
                    setIsLoggingIn(false);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-6 text-center">
                    <div className="max-w-md w-full">
                        <div className="w-20 h-20 bg-white neomorph-shadow rounded-3xl flex items-center justify-center mx-auto mb-6"><Icon name="GraduationCap" size={32} className="text-blue-600" /></div>
                        <h1 className="text-3xl font-black italic mb-10 tracking-tighter">school space</h1>
                        
                        <div className="space-y-6">
                            <button onClick={handleGoogle} disabled={isLoggingIn} className={`${styles.neptunButton} w-full py-5 rounded-2xl flex items-center justify-center gap-4 font-bold text-gray-700`}>
                                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" className="w-5 h-5" />
                                {isLoggingIn ? "Завантаження..." : "Увійти через Google"}
                            </button>
                            
                            <div className="flex items-center justify-center gap-3">
                                <button 
                                    onClick={() => setRememberMe(!rememberMe)}
                                    className={`w-6 h-6 rounded-lg flex items-center justify-center transition-all ${rememberMe ? 'bg-blue-600 text-white shadow-md' : 'neomorph-inset bg-[#e0e5ec]'}`}
                                >
                                    {rememberMe && <Icon name="Check" size={14} className="stroke-[4]" />}
                                </button>
                                <span className="text-[10px] uppercase font-black text-gray-400 tracking-[0.2em]">Запам'ятати мене</span>
                            </div>

                            <div className="pt-4 space-y-4">
                                <div className="text-[10px] text-gray-300 font-black uppercase tracking-[0.5em]">АБО</div>
                                <button onClick={() => signInAnonymously(auth)} className="text-xs text-gray-400 font-bold hover:text-blue-500 transition-colors">Переглянути як гість</button>
                            </div>

                            <button onClick={onShowGuide} className="w-full mt-10 py-3 rounded-xl border border-dashed border-blue-200 text-blue-500 text-[10px] font-black uppercase tracking-widest italic flex items-center justify-center gap-2">
                                <Icon name="Smartphone" size={14} /> Як встановити додаток?
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        function Feed({ posts }) {
            if (posts.length === 0) return <div className="text-center py-20 italic text-gray-400 font-medium">Стрічка порожня. Станьте першим!</div>;
            return <div className="space-y-10">{posts.map(p => (
                <div key={p.id} className={`${styles.neptunCard} p-6 border border-white/40`}>
                    <div className="flex items-center gap-3 mb-5">
                        <div className="w-10 h-10 rounded-2xl bg-blue-600 text-white flex items-center justify-center font-black italic uppercase shadow-sm">{p.authorName?.[0]}</div>
                        <div>
                            <p className="font-bold text-sm text-gray-800">@{p.authorName}</p>
                            <p className="text-[8px] text-gray-400 font-black uppercase tracking-tighter">Школа {p.school || '?'}</p>
                        </div>
                    </div>
                    <p className="text-gray-700 italic font-medium leading-relaxed mb-4">"{p.text}"</p>
                    {p.mediaUrl && <img src={p.mediaUrl} className="w-full rounded-2xl mb-4 neomorph-shadow border-4 border-[#e0e5ec]" onError={(e) => e.target.style.display='none'} />}
                    <div className="flex justify-between items-center text-red-400 pt-4 border-t border-white/60">
                        <button className="flex items-center gap-2 font-black text-[10px] uppercase active:scale-90 transition-transform"><Icon name="Heart" size={18}/> Лайк</button>
                    </div>
                </div>
            ))}</div>;
        }

        function Chat({ messages, user, userData }) {
            const [text, setText] = useState("");
            const scrollRef = useRef(null);
            
            useEffect(() => { 
                if (scrollRef.current) scrollRef.current.scrollTop = scrollRef.current.scrollHeight; 
            }, [messages]);

            const send = async () => {
                if (!text.trim()) return;
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'messages'), {
                        text, senderId: user.uid, senderName: userData?.username || user.displayName || "Учень", createdAt: serverTimestamp()
                    });
                    setText("");
                } catch (e) { console.error(e); }
            };

            return (
                <div className="flex flex-col h-[calc(100vh-220px)]">
                    <div ref={scrollRef} className="flex-1 space-y-4 overflow-y-auto mb-4 pr-2">
                        {messages.map((m, i) => (
                            <div key={i} className={`flex ${m.senderId === user.uid ? 'justify-end' : 'justify-start'}`}>
                                <div className={`max-w-[80%] p-4 rounded-[22px] text-sm font-medium ${m.senderId === user.uid ? 'bg-blue-600 text-white shadow-lg' : 'bg-white text-gray-700 shadow-sm'}`}>
                                    {m.senderId !== user.uid && <p className="text-[8px] font-black uppercase text-gray-400 mb-1">@{m.senderName}</p>}
                                    {m.text}
                                </div>
                            </div>
                        ))}
                    </div>
                    <div className="flex gap-3 bg-[#e0e5ec] pt-2">
                        <input className={styles.neptunInput} placeholder="Повідомлення..." value={text} onChange={e => setText(e.target.value)} onKeyDown={e => e.key === 'Enter' && send()} />
                        <button onClick={send} className={`${styles.neptunButton} p-5 rounded-2xl text-blue-600 transition-transform active:scale-90`}><Icon name="Send" /></button>
                    </div>
                </div>
            );
        }

        function CreatePost({ onDone, user, userData }) {
            const [text, setText] = useState("");
            const [posting, setPosting] = useState(false);

            const submit = async () => {
                if (!text.trim() || posting) return;
                setPosting(true);
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'posts'), {
                        text, authorId: user.uid, authorName: userData?.username || user.displayName || "Учень", school: userData?.school || "Невідомо", createdAt: serverTimestamp()
                    });
                    onDone();
                } catch (e) { console.error(e); } finally { setPosting(false); }
            };

            return (
                <div className={`${styles.neptunCard} p-8 animate-in slide-in-from-bottom-4`}>
                    <h2 className="text-xl font-black italic uppercase mb-6 text-gray-800 tracking-tighter">Створити пост</h2>
                    <textarea className={`${styles.neptunInput} h-40 mb-6 text-base italic`} placeholder="Поділися новинами зі школи..." value={text} onChange={e => setText(e.target.value)} />
                    <div className="flex gap-4">
                        <button onClick={onDone} className="flex-1 font-black text-[10px] text-gray-400 uppercase tracking-widest italic">Скасувати</button>
                        <button disabled={posting} onClick={submit} className={`${styles.neptunButton} flex-[2] py-5 rounded-2xl text-blue-600 font-black uppercase tracking-widest italic`}>
                            {posting ? "Опублікувати..." : "Опублікувати"}
                        </button>
                    </div>
                </div>
            );
        }

        function ProfileComponent({ user, userData, onShowGuide }) {
            return (
                <div className="text-center py-6">
                    <div className="w-28 h-28 rounded-full bg-blue-600 text-white flex items-center justify-center mx-auto mb-8 text-4xl font-black italic neomorph-shadow uppercase">
                        {userData?.username?.[0] || user.displayName?.[0] || 'S'}
                    </div>
                    <h2 className="text-3xl font-black italic tracking-tighter">@{userData?.username || user.displayName || 'user'}</h2>
                    <p className="text-[10px] text-gray-400 font-black uppercase tracking-[0.3em] mt-2 mb-10">Учень школи №{userData?.school || '?'}</p>
                    
                    <div className="grid grid-cols-1 gap-4 max-w-sm mx-auto">
                        <button onClick={onShowGuide} className={`${styles.neptunButton} w-full py-5 rounded-2xl font-black text-blue-600 text-[10px] uppercase tracking-widest flex items-center justify-center gap-3 italic`}>
                            <Icon name="Smartphone" size={18}/> Встановити додаток
                        </button>
                        <button onClick={() => signOut(auth)} className={`${styles.neptunButton} w-full py-5 rounded-2xl font-black text-red-500 text-[10px] uppercase tracking-widest flex items-center justify-center gap-3 italic`}>
                            <Icon name="LogOut" size={18}/> Вийти з акаунта
                        </button>
                    </div>
                </div>
            );
        }

        function Locked({ message }) {
            return <div className={`${styles.neptunCard} p-12 text-center text-gray-500 italic font-bold`}>
                <Icon name="Lock" className="mx-auto mb-4 text-gray-300" size={32} />
                {message}
            </div>;
        }

        function InstallGuide({ onClose }) {
            return (
                <div className="min-h-screen flex items-center justify-center p-6 bg-[#e0e5ec]">
                    <div className={`${styles.neptunCard} p-10 max-w-sm w-full text-center relative`}>
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-400"><Icon name="X" /></button>
                        <div className="w-16 h-16 bg-blue-600 rounded-2xl flex items-center justify-center text-white mx-auto mb-6 shadow-lg"><Icon name="Smartphone" size={32} /></div>
                        <h2 className="text-xl font-black italic mb-6 tracking-tighter uppercase">Встановити</h2>
                        <ol className="text-left space-y-6 text-sm font-medium">
                            <li className="flex gap-4"><span className="w-6 h-6 rounded-full bg-blue-600 text-white flex shrink-0 items-center justify-center text-[10px] font-black">1</span> Відкрийте меню браузера (кнопка "Поділитися" або "Три крапки").</li>
                            <li className="flex gap-4"><span className="w-6 h-6 rounded-full bg-blue-600 text-white flex shrink-0 items-center justify-center text-[10px] font-black">2</span> Оберіть пункт "Додати на гол. екран".</li>
                        </ol>
                        <button onClick={onClose} className="mt-10 text-[10px] text-gray-400 font-black uppercase tracking-widest underline underline-offset-4">Закрити</button>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
